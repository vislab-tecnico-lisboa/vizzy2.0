<!--
  * Main changes from ROS1 to ROS2:
  *  - 'arg' tags in substitutions are replaced with 'var' tags (not in declarations).
-->

<launch>

  <arg name="vizzy_machine_name" default="vizzy-desktop.local"/>
  <arg name="vizzy_machine_address" default="vizzy-desktop.local"/>
  <arg name="env-loader" default="$(find vizzy_launch)/env-hooks/env_loader.sh"/>
  <arg name="define_machine" default="true"/>

    <machine name="$(arg vizzy_machine_name)" 
            address="$(arg vizzy_machine_address)" 
            env-loader="$(arg env-loader)" user="vizzy"
            if="$(arg define_machine)"
    />


  <!-- robot configuration parameters -->
  <arg name="robot" default="vizzy"/> <!-- full, lower_body, foot -->

  <!-- simulation parameters and robot configuration parameters -->
  <arg name="navigation" default="true"/>
  <arg name="slam" default="false"/>
  <arg name="gui" default="true"/>
  <arg name="map_frame" default="map" />
  <arg name="tf_prefix" default="" />
  <arg name="base_frame_id" default="base_footprint" />
  <arg name="odom_frame_id" default="odometry" />
  <arg name="map_topic" default="/map" />
  <!-- <arg name="map_file" default="atrio_civil.yaml" /> -->
  <arg name="map_file" default="mapa_piso7_NOVO_AWESOME.yaml" />
  <arg name="use_moveit" default="false" />

  <arg name="custom_obstacles" default="true" />
  <!-- <arg name="obstacles_map_file" default="atrio_civil_obs.yaml" /> -->
  <arg name="obstacles_map_file" default="mapa_piso7_NOVO_AWESOME_obst.yaml" />

  <arg name="ns" default="vizzy" />

  <!-- bringup robot -->
  <include file="$(find vizzy_robot)/launch/real_robot.launch">
    <arg name="map_frame" value="$(var map_frame)" />
    <arg name="tf_prefix" value="$(var tf_prefix)" />
    <arg name="vizzy_machine_name" value="$(var vizzy_machine_name)"/>
    <arg name="ns" value="$(var ns)" />
    <arg name="ros_cameras_on" value="$(var ros_cameras_on)" />
    <arg name="cameras_auto_gain" value="$(var cameras_auto_gain)" />
    <arg name="cameras_auto_exposure" value="$(var cameras_auto_exposure)" />
    <arg name="cameras_auto_frame_rate" value="$(var cameras_auto_frame_rate)" />
    <arg name="define_machine" value="false"/>
  </include> 

  <!-- launch navigation -->
  <group if="$(var navigation)">

    <!-- launch the laser filter to get rid of readings from the robot itself -->
   <node machine="$(var vizzy_machine_name)" name="hokuyo_laser_filters" 
         pkg="laser_filters" type="scan_to_scan_filter_chain">
     <rosparam command="load" file="$(find vizzy_sensors)/config/hokuyo_filters.yaml" />
   </node>
   <node machine="$(var vizzy_machine_name)" name="hokuyo_laser_filters_rear" pkg="laser_filters" type="scan_to_scan_filter_chain">
      <rosparam command="load" file="$(find vizzy_sensors)/config/hokuyo_filters.yaml" />
      <remap from="scan" to="scan_rear"/>
      <remap from="scan_filtered" to="scan_filtered_rear"/>
    </node>

    <group unless="$(var slam)">
      <!-- launch pre obtained map to the environment -->
      <node machine="$(var vizzy_machine_name)" 
            name="map_server" pkg="map_server" 
            type="map_server" args="$(find vizzy_navigation)/maps/$(var map_file)" 
      />

      <group if="$(var custom_obstacles)" ns="obst">
        <node name="obstacle_map_server" 
              pkg="map_server" 
              type="map_server" 
              args="$(find vizzy_navigation)/maps/$(var obstacles_map_file)" >
          <remap from="map" to="map_obstacles"/>    
        </node>
      </group>

      <!-- Launch navigation -->
      <include file="$(find-pkg-share vizzy_navigation)/launch/navigation_launch.py">
        <arg name="params_file" value="$(find-pkg-share vizzy_navigation)/config/nav2_configuration.yaml"/>
        <arg name="use_sim_time" value="false"/>
        <arg name="map_yaml" value="$(var obstacles_map_file)"/>
      </include>

    </group>
  </group>
</launch>